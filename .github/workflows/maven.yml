name: Java Selenium Maven Workflow
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up JDK 19
      uses: actions/setup-java@v2
      with:
        java-version: 19
        distribution: 'adopt'

    - name: Cache Maven dependencies
      uses: actions/cache@v2
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-maven-
        
    - name: Start Chrome
      run: |
         choco install chromium
         choco install chromedriver

    - name: Build and test with Maven
      run: |
         mvn install
         mvn test 
         exit 0

    - name: Download CodeQL Bundle
      run: |
         Invoke-WebRequest -Uri "https://github.com/github/codeql-action/releases/latest/download/codeql-bundle.tar.gz" -OutFile "codeql-bundle.tar.gz"
   
    - name: Extract CodeQL Bundle
      run: tar xzf codeql-bundle.tar.gz
   
    - name: Convert JaCoCo report to SARIF
      run: |
         ./codeql/codeql database create codeql-db --language=java --source-root=./ --ram=2048
         ./codeql/codeql database analyze codeql-db --format=sarif-latest --output=report.sarif
   
    - name: Upload JaCoCo report as artifact
      uses: actions/upload-artifact@v2
      with:
        name: jacoco-report
        path: target/site/jacoco
   
    - name: Upload SARIF report as artifact
      uses: actions/upload-artifact@v2
      with:
        name: sarif-report
        path: report.sarif
